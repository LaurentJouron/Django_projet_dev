{% extends 'layouts/account-layout.html' %}
{% load static %}

{% block title %}Inscription - ProjetDev{% endblock title %}
{% block attrs %}{% endblock attrs %}

{% block content %}
    <div class="max-w-[360px] mx-auto">
        <h1 class="text-center pb-4">Inscription</h1>
        <div class="mb-10">
            <form method="POST" 
                  action="{% url 'account_signup' %}?next={{ request.GET.next|urlencode }}" 
                  x-data="signupComponent()"
                  aria-label="Formulaire d'inscription">

                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div role="alert" class="error mb-4">
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}

                <!-- Date de naissance -->
                <fieldset class="mb-6">
                    <legend class="font-medium text-sm mb-1">
                        Date de naissance
                        <span class="sr-only">(requis)</span>
                    </legend>

                    <div class="grid grid-cols-[1fr_1.5fr_1fr] gap-2 mb-1">
                        <!-- Sélecteur de jour -->
                        <div @click.outside="selectDay = false" class="relative">
                            <button type="button"
                                    @click="selectDay = !selectDay" 
                                    class="bg-neutral-100 px-3 h-11 w-full flex items-center justify-between rounded-sm cursor-pointer"
                                    aria-label="Sélectionner le jour"
                                    aria-expanded="false"
                                    :aria-expanded="selectDay"
                                    :aria-describedby="day ? null : 'day-hint'">
                                <span x-text="day || 'Jour'" 
                                      class="select-none" 
                                      :class="day ? 'text-black' : 'text-neutral-400'">
                                    Jour
                                </span>
                                <div :class="selectDay ? 'rotate-180' : 'rotate-0'" 
                                     class="w-4 h-4 transition-transform duration-300"
                                     aria-hidden="true">
                                    <svg viewBox="0 0 48 48">
                                        <path d="M25.5187 35.2284C24.7205 36.1596 23.2798 36.1596 22.4816 35.2284L8.83008 19.3016C7.71807 18.0042 8.63988 16 10.3486 16H37.6517C39.3604 16 40.2822 18.0042 39.1702 19.3016L25.5187 35.2284Z"></path>
                                    </svg>
                                </div>
                            </button>
                            <div x-show="selectDay" 
                                 x-cloak 
                                 class="absolute bg-white w-full top-12 left-0 rounded-sm drop-shadow-lg z-1"
                                 role="listbox"
                                 aria-label="Liste des jours">
                                <ul class="max-h-68 overflow-y-auto">
                                    <template x-for="d in days">
                                        <li @click="selectDay = false; day = d" 
                                            x-text="d" 
                                            class="px-3 py-1.5 hover:bg-neutral-100 cursor-pointer"
                                            role="option"
                                            :aria-selected="day === d"
                                            tabindex="0"
                                            @keydown.enter="selectDay = false; day = d"
                                            @keydown.space.prevent="selectDay = false; day = d">
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </div>

                        <!-- Sélecteur de mois -->
                        <div @click.outside="selectMonth = false" class="relative">
                            <button type="button"
                                    @click="selectMonth = !selectMonth" 
                                    class="bg-neutral-100 px-3 h-11 w-full flex items-center justify-between rounded-sm cursor-pointer"
                                    aria-label="Sélectionner le mois"
                                    aria-expanded="false"
                                    :aria-expanded="selectMonth">
                                <span x-text="month || 'Mois'" 
                                      class="select-none" 
                                      :class="month ? 'text-black' : 'text-neutral-400'">
                                    Mois
                                </span>
                                <div :class="selectMonth ? 'rotate-180' : 'rotate-0'" 
                                     class="w-4 h-4 transition-transform duration-300"
                                     aria-hidden="true">
                                    <svg viewBox="0 0 48 48">
                                        <path d="M25.5187 35.2284C24.7205 36.1596 23.2798 36.1596 22.4816 35.2284L8.83008 19.3016C7.71807 18.0042 8.63988 16 10.3486 16H37.6517C39.3604 16 40.2822 18.0042 39.1702 19.3016L25.5187 35.2284Z"></path>
                                    </svg>
                                </div>
                            </button>
                            <div x-show="selectMonth" 
                                 x-cloak 
                                 class="absolute bg-white w-full top-12 left-0 rounded-sm drop-shadow-lg z-1"
                                 role="listbox"
                                 aria-label="Liste des mois">
                                <ul class="max-h-68 overflow-y-auto">
                                    <template x-for="m in months">
                                        <li @click="selectMonth = false; month = m" 
                                            x-text="m" 
                                            class="px-3 py-1.5 hover:bg-neutral-100 cursor-pointer"
                                            role="option"
                                            :aria-selected="month === m"
                                            tabindex="0"
                                            @keydown.enter="selectMonth = false; month = m"
                                            @keydown.space.prevent="selectMonth = false; month = m">
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </div>

                        <!-- Sélecteur d'année -->
                        <div @click.outside="selectYear = false" class="relative">
                            <button type="button"
                                    @click="selectYear = !selectYear" 
                                    class="bg-neutral-100 px-3 h-11 w-full flex items-center justify-between rounded-sm cursor-pointer"
                                    aria-label="Sélectionner l'année"
                                    aria-expanded="false"
                                    :aria-expanded="selectYear">
                                <span x-text="year || 'Année'" 
                                      class="select-none" 
                                      :class="year ? 'text-black' : 'text-neutral-400'">
                                    Année
                                </span>
                                <div :class="selectYear ? 'rotate-180' : 'rotate-0'" 
                                     class="w-4 h-4 transition-transform duration-300"
                                     aria-hidden="true">
                                    <svg viewBox="0 0 48 48">
                                        <path d="M25.5187 35.2284C24.7205 36.1596 23.2798 36.1596 22.4816 35.2284L8.83008 19.3016C7.71807 18.0042 8.63988 16 10.3486 16H37.6517C39.3604 16 40.2822 18.0042 39.1702 19.3016L25.5187 35.2284Z"></path>
                                    </svg>
                                </div>
                            </button>
                            <div x-show="selectYear" 
                                 x-cloak 
                                 class="absolute bg-white w-full top-12 left-0 rounded-sm drop-shadow-lg z-1"
                                 role="listbox"
                                 aria-label="Liste des années">
                                <ul class="max-h-68 overflow-y-auto">
                                    <template x-for="y in years">
                                        <li @click="selectYear = false; year = y" 
                                            x-text="y" 
                                            class="px-3 py-1.5 hover:bg-neutral-100 cursor-pointer"
                                            role="option"
                                            :aria-selected="year === y"
                                            tabindex="0"
                                            @keydown.enter="selectYear = false; year = y"
                                            @keydown.space.prevent="selectYear = false; year = y">
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="birthday" :value="birthday" aria-label="Date de naissance sélectionnée">

                    <p class="text-neutral-400 text-sm mb-6" id="birthday-hint">
                        Ta date de naissance ne sera pas publique.
                    </p>
                </fieldset>

                <!-- Email -->
                <div class="mb-4">
                    <label for="email-field" class="font-medium text-sm mb-1 block">
                        Email
                        <span class="sr-only">(requis)</span>
                    </label>
                    <input x-model='email' 
                           id="email-field"
                           name="email" 
                           type="email" 
                           placeholder="Adresse mail" 
                           class="input-field" 
                           required
                           autocomplete="email"
                           aria-required="true"
                           :aria-invalid="email && !email.includes('@') ? 'true' : 'false'">
                    {% if form.email.errors %}
                        <div role="alert" class="error mt-1">
                            {{ form.email.errors }}
                        </div>
                    {% endif %}
                </div>

                <!-- Mot de passe -->
                <div class="mb-4">
                    <label for="password1-field" class="font-medium text-sm mb-1 block">
                        Mot de passe
                        <span class="sr-only">(requis)</span>
                    </label>
                    <div x-data="{ password_show: false }" class="relative w-full">
                        <input x-model="password1" 
                               id="password1-field"
                               name="password1" 
                               :type="password_show ? 'text' : 'password'" 
                               placeholder="Mot de passe" 
                               class="input-field pr-12" 
                               required
                               autocomplete="new-password"
                               aria-required="true"
                               aria-describedby="password-requirements">
                        <button type="button"
                                @click="password_show = !password_show" 
                                class="h-5 w-5 absolute top-3 right-3.5 fill-neutral-500 cursor-pointer"
                                :aria-label="password_show ? 'Masquer le mot de passe' : 'Afficher le mot de passe'"
                                :aria-pressed="password_show">
                            <svg x-show="!password_show" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M38.88 41.7a1 1 0 0 0 1.41 0l1.42-1.4a1 1 0 0 0 0-1.42l-3.86-3.86a24.57 24.57 0 0 0 6.27-9.69 1 1 0 0 0 0-.66C41 15.8 32.66 9 23 9c-3.27 0-6.35.73-9.12 2.05L9.12 6.29a1 1 0 0 0-1.41 0L6.29 7.71a1 1 0 0 0 0 1.41l32.59 32.59Zm-22-27.66A17.8 17.8 0 0 1 23 13c12.75 0 17 12 17 12s-1.38 3.9-4.93 7.25l-4.54-4.55A7.99 7.99 0 0 0 23 17c-.95 0-1.86.16-2.7.47l-3.43-3.43ZM1.87 24.67a24.64 24.64 0 0 1 5.8-9.23l2.77 2.78C7.25 21.46 6 25 6 25s4.25 12 17 12a18 18 0 0 0 5.42-.8l3.05 3.05A21.2 21.2 0 0 1 23 41c-9.83 0-17.93-6.63-21.13-15.67a1 1 0 0 1 0-.66Z"></path>
                                <path d="M15 25c0-.68.08-1.35.24-1.98l9.74 9.73A8.02 8.02 0 0 1 15 25Z"></path>
                            </svg>
                            <svg x-show="password_show" x-cloak viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M41.4 23.71a.9.9 0 0 1 0 .58c-.63 1.92-2.2 4.89-4.82 7.51A17.35 17.35 0 0 1 24 37.11c-5.42 0-9.55-2.28-12.58-5.3a20.44 20.44 0 0 1-4.82-7.52.9.9 0 0 1 0-.58c.63-1.92 2.2-4.89 4.82-7.51A17.35 17.35 0 0 1 24 10.89c5.42 0 9.55 2.28 12.58 5.3a20.44 20.44 0 0 1 4.82 7.52ZM24 41c13.83 0 20.82-11.7 21.96-16.81a.85.85 0 0 0 0-.38C44.82 18.71 37.83 7 24 7S3.18 18.7 2.04 23.81a.85.85 0 0 0 0 .38C3.18 29.29 10.17 41 24 41Z"></path>
                                <path d="M24 27.21a3.21 3.21 0 1 1 0-6.42 3.21 3.21 0 0 1 0 6.42Zm0 4.29a7.5 7.5 0 1 0 0-15 7.5 7.5 0 0 0 0 15Z"></path>
                            </svg>
                        </button>
                    </div>
                    {% if form.password1.errors %}
                        <div role="alert" class="error mt-1">
                            {{ form.password1.errors }}
                        </div>
                    {% endif %}
                </div>

                <!-- Confirmation mot de passe -->
                <div class="mb-4">
                    <label for="password2-field" class="font-medium text-sm mb-1 block">
                        Confirmer le mot de passe
                        <span class="sr-only">(requis)</span>
                    </label>
                    <div x-data="{ password_show: false }" class="relative w-full">
                        <input x-model="password2" 
                               id="password2-field"
                               name="password2" 
                               :type="password_show ? 'text' : 'password'" 
                               placeholder="Confirmer le mot de passe" 
                               class="input-field pr-12" 
                               required
                               autocomplete="new-password"
                               aria-required="true">
                        <button type="button"
                                @click="password_show = !password_show" 
                                class="h-5 w-5 absolute top-3 right-3.5 fill-neutral-500 cursor-pointer"
                                :aria-label="password_show ? 'Masquer le mot de passe' : 'Afficher le mot de passe'"
                                :aria-pressed="password_show">
                            <svg x-show="!password_show" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M38.88 41.7a1 1 0 0 0 1.41 0l1.42-1.4a1 1 0 0 0 0-1.42l-3.86-3.86a24.57 24.57 0 0 0 6.27-9.69 1 1 0 0 0 0-.66C41 15.8 32.66 9 23 9c-3.27 0-6.35.73-9.12 2.05L9.12 6.29a1 1 0 0 0-1.41 0L6.29 7.71a1 1 0 0 0 0 1.41l32.59 32.59Zm-22-27.66A17.8 17.8 0 0 1 23 13c12.75 0 17 12 17 12s-1.38 3.9-4.93 7.25l-4.54-4.55A7.99 7.99 0 0 0 23 17c-.95 0-1.86.16-2.7.47l-3.43-3.43ZM1.87 24.67a24.64 24.64 0 0 1 5.8-9.23l2.77 2.78C7.25 21.46 6 25 6 25s4.25 12 17 12a18 18 0 0 0 5.42-.8l3.05 3.05A21.2 21.2 0 0 1 23 41c-9.83 0-17.93-6.63-21.13-15.67a1 1 0 0 1 0-.66Z"></path>
                                <path d="M15 25c0-.68.08-1.35.24-1.98l9.74 9.73A8.02 8.02 0 0 1 15 25Z"></path>
                            </svg>
                            <svg x-show="password_show" x-cloak viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M41.4 23.71a.9.9 0 0 1 0 .58c-.63 1.92-2.2 4.89-4.82 7.51A17.35 17.35 0 0 1 24 37.11c-5.42 0-9.55-2.28-12.58-5.3a20.44 20.44 0 0 1-4.82-7.52.9.9 0 0 1 0-.58c.63-1.92 2.2-4.89 4.82-7.51A17.35 17.35 0 0 1 24 10.89c5.42 0 9.55 2.28 12.58 5.3a20.44 20.44 0 0 1 4.82 7.52ZM24 41c13.83 0 20.82-11.7 21.96-16.81a.85.85 0 0 0 0-.38C44.82 18.71 37.83 7 24 7S3.18 18.7 2.04 23.81a.85.85 0 0 0 0 .38C3.18 29.29 10.17 41 24 41Z"></path>
                                <path d="M24 27.21a3.21 3.21 0 1 1 0-6.42 3.21 3.21 0 0 1 0 6.42Zm0 4.29a7.5 7.5 0 1 0 0-15 7.5 7.5 0 0 0 0 15Z"></path>
                            </svg>
                        </button>
                    </div>
                    {% if form.password2.errors %}
                        <div role="alert" class="error mt-1">
                            {{ form.password2.errors }}
                        </div>
                    {% endif %}
                </div>

                <!-- Code de validation -->
                <div class="mb-4">
                    <label for="code-field" class="font-medium text-sm mb-1 block">
                        Code de validation
                        <span class="sr-only">(requis)</span>
                    </label>
                    <div class="flex">
                        <input x-model="code" 
                               id="code-field"
                               name="code" 
                               type="text" 
                               inputmode="numeric"
                               pattern="[0-9]{6}"
                               placeholder="Code à 6 chiffres" 
                               class="input-field !w-2/3 !rounded-none !rounded-l-sm" 
                               maxlength="6"
                               required
                               aria-required="true"
                               aria-describedby="code-message">
                        <button type="button"
                                hx-get="{% url 'users:verification_code' %}"
                                hx-include="input[name='email']"
                                hx-target="#code-message"
                                hx-swap="innerHTML"
                                class="input-field !w-1/3 text-center font-medium text-neutral-400 select-none !rounded-none !rounded-r-sm"
                                :class="email ? 'cursor-pointer !bg-neutral-200 hover:!bg-neutral-300 !text-neutral-500' : '!cursor-not-allowed'"
                                :disabled="!email"
                                :aria-disabled="!email"
                                aria-label="Envoyer le code de validation par email">
                            Valider
                        </button>
                    </div>
                    <div id="code-message" class="text-sm mt-1" role="status" aria-live="polite">
                        {% if form.code.errors %}
                            <span class="error">{{ form.code.errors }}</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Nom d'usage -->
                <div class="mb-4">
                    <label for="username-field" class="font-medium text-sm mb-1 block">
                        Nom d'usage
                        <span class="sr-only">(requis)</span>
                    </label>
                    <input x-model="username" 
                           id="username-field"
                           name="username" 
                           type="text" 
                           placeholder="Nom d'usage" 
                           class="input-field" 
                           required
                           autocomplete="username"
                           aria-required="true">
                    {% if form.username.errors %}
                        <div role="alert" class="error mt-1">
                            {{ form.username.errors }}
                        </div>
                    {% endif %}
                </div>

                <!-- Checkbox contenu tendance -->
                <div class="mb-6">
                    <label class="flex gap-2 cursor-pointer">
                        <input type="checkbox" 
                               name="content_trends"
                               class="size-5.5 mt-0.5 checked:accent-[#366BF5] flex-shrink-0"
                               aria-describedby="content-trends-description">
                        <span id="content-trends-description" class="text-xs text-neutral-600 leading-4">
                            Recevez du contenu tendance, des newsletters, des promotions, des recommandations et des mises à jour.
                        </span>
                    </label>
                </div>

                <!-- Bouton d'inscription -->
                <button :type="buttonActive ? 'submit' : 'button'" 
                        class="button" 
                        :class="{ 'button-active' : buttonActive }"
                        :disabled="!buttonActive"
                        :aria-disabled="!buttonActive">
                    S'inscrire
                </button>
            </form>
        </div>

        <nav aria-label="Navigation secondaire">
            <a href="{% url 'users:index' %}" 
               class="flex items-center justify-center gap-1"
               aria-label="Retour à la page d'accueil">
                <div class="w-3.5 h-3.5" aria-hidden="true">
                    <svg viewBox="0 0 48 48">
                        <path d="M4.58579 22.5858L20.8787 6.29289C21.2692 5.90237 21.9024 5.90237 22.2929 6.29289L23.7071 7.70711C24.0976 8.09763 24.0976 8.7308 23.7071 9.12132L8.82843 24L23.7071 38.8787C24.0976 39.2692 24.0976 39.9024 23.7071 40.2929L22.2929 41.7071C21.9024 42.0976 21.2692 42.0976 20.8787 41.7071L4.58579 25.4142C3.80474 24.6332 3.80474 23.3668 4.58579 22.5858Z"></path>
                    </svg>
                </div>
                <span class="font-medium text-sm">Retour</span>
            </a>
        </nav>
    </div>

    <script>
        function signupComponent() {
            const months = Array.from({ length: 12 }, (_, i) =>
                new Date(0, i).toLocaleString('fr', { month: 'long' })
            );
            const currentYear = new Date().getFullYear();
            return {
                selectMonth: false, month: '',
                selectDay: false, day: '',
                selectYear: false, year: '',
                email: '',
                password1: '',
                password2: '',
                code: '',
                username: '',
                days: Array.from({ length: 31 }, (_, i) => i + 1),
                months: months,
                years: Array.from({ length: 100 }, (_, i) => currentYear - 1 - i),

                get birthday() {
                    const monthsMaps = months.reduce((accumulator, month, index) => {
                        accumulator[month] = String(index + 1).padStart(2, '0');
                        return accumulator;
                    }, {});
                    return `${this.year}-${monthsMaps[this.month]}-${String(this.day).padStart(2, '0')}`;
                },

                get buttonActive() {
                    return this.day && this.month && this.year && this.email && this.password1 && this.password2 && this.code && this.username
                }
            }
        }
    </script>
{% endblock content %}

{% block terms %}
    {% include "../includes/account_terms.html" %}
{% endblock terms %}

{% block has_account %}
    {% include "../includes/account_login.html" %}
{% endblock has_account %}