<div id="chat-page" class="ml-18 lg:ml-110 lg:mr-12 p-3 h-full" {% if chat %}hx-ext="ws" ws-connect="/ws/chat/{{ chat.id }}/"{% endif %}>
    <div class="h-full flex flex-col">
        <div class="pb-3 border-b border-neutral-300 dark:border-neutral-800 mb-5">

            <a href="{% url 'users:profile' receiver.username %}" class="inline-flex items-center gap-3">
                <img src="{{ receiver.avatar }}" alt="" class="size-14 rounded-full object-cover">
                <div class="font-medium">{{ receiver.username }} {% if is_self %}(Toi){% endif %}</div>
                <div class="text-xs">{% if is_self %}Ton message{% elif chat %}Dernière vue il y a {{ chat.updated_at|timesince }} {% endif %}</div>
            </a>
        </div>

        <div id="messages-list" class="flex-1 flex flex-col gap-4 overflow-y-auto hide-scrollbar"
            x-data x-init="$nextTick(() => scrollMessagesToBottom())"
            hx-on::after-settle="scrollMessagesToBottom()">
            {% for message in messages %}
                {% include "messages/message.html" %}
            {% endfor %}
        </div>

        <form action="" class="flex items-center gap-3 mt-6 mb-2"
            hx-post="{% url 'messages:send_message' receiver.id %}"
            {% if chat %}
                hx-target="#messages-list"
                hx-swap="none"
            {% else %}
                hx-target="#chat-page"
                hx-swap="outerHTML"
            {% endif %}
            hx-trigger="submit"
            hx-on::after-request="this.reset()"
            enctype="multipart/form-data">
            {% csrf_token %}
            <div x-data="emojiPicker()" class="relative flex-1" @click.outside="emojiOpen = false">
                <input x-ref="messageInput" type="text" name="body" id="message-input" placeholder="Écrire un message..." class="w-full rounded-md px-4 pr-12 bg-neutral-100 dark:bg-neutral-800 outline-none" autocomplete="off">
                <input x-ref="imageInput" type="file" name="image" class="hidden" accept="image/*" @change="$el.closest('form').requestSubmit()">
                <button type="button" @click="$refs.imageInput.click()" class="absolute right-11 top-1/2 -translate-y-1/2 opacity-70 hover:opacity-100">
                    <div class="size-6">
                        <svg viewBox="0 0 48 48">
                            <path d="M16.8 8c-2.3 0-3.8 0-4.93.1a4.56 4.56 0 0 0-1.69.34 4 4 0 0 0-1.74 1.74c-.1.2-.26.6-.34 1.7C8 13 8 14.48 8 16.8v8.68l.87-.86c.76-.76 1.42-1.4 2-1.9a6.12 6.12 0 0 1 2.1-1.23 6 6 0 0 1 3.76.05c.81.28 1.47.75 2.07 1.29.57.5 1.2 1.17 1.95 1.95l14.6 15.17.78-.05a4.56 4.56 0 0 0 1.69-.34 4 4 0 0 0 1.74-1.74c.1-.2.26-.6.34-1.7.1-1.12.1-2.61.1-4.92V16.8c0-2.3 0-3.8-.1-4.93a4.56 4.56 0 0 0-.34-1.69 4 4 0 0 0-1.74-1.74c-.2-.1-.6-.26-1.7-.34C35 8 33.52 8 31.2 8H16.8ZM8 31.11v.09c0 2.3 0 3.8.1 4.93.08 1.09.24 1.49.34 1.69a4 4 0 0 0 1.74 1.74c.2.1.6.26 1.7.34 1.12.1 2.61.1 4.92.1h13.07L17.9 27.6a34.4 34.4 0 0 0-1.77-1.78 2.29 2.29 0 0 0-.71-.5 2 2 0 0 0-1.25-.02c-.11.04-.31.12-.74.48-.44.37-.98.9-1.81 1.73L8 31.11ZM4 16.8c0-4.48 0-6.72.87-8.43a8 8 0 0 1 3.5-3.5C10.07 4 12.32 4 16.8 4h14.4c4.48 0 6.72 0 8.43.87a8 8 0 0 1 3.5 3.5c.87 1.7.87 3.95.87 8.43v14.4c0 4.48 0 6.72-.87 8.43a8 8 0 0 1-3.5 3.5c-1.7.87-3.95.87-8.43.87H16.8c-4.48 0-6.72 0-8.43-.87a8 8 0 0 1-3.5-3.5C4 37.93 4 35.68 4 31.2V16.8ZM31 12a5 5 0 1 0 0 10 5 5 0 0 0 0-10Z"></path>
                        </svg>
                    </div>
                </button>
                <button type="button" @click.stop="emojiToggle" class="absolute right-3 top-1/2 -translate-y-1/2 opacity-70 hover:opacity-100">
                    <div class="size-6">
                        <svg viewBox="0 0 48 48" >
                            <path d="M24 6C14.0589 6 6 14.0589 6 24C6 33.9411 14.0589 42 24 42C33.9411 42 42 33.9411 42 24C42 14.0589 33.9411 6 24 6ZM2 24C2 11.8497 11.8497 2 24 2C36.1503 2 46 11.8497 46 24C46 36.1503 36.1503 46 24 46C11.8497 46 2 36.1503 2 24Z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M17 23C18.6569 23 20 21.2091 20 19C20 16.7909 18.6569 15 17 15C15.3431 15 14 16.7909 14 19C14 21.2091 15.3431 23 17 23Z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M31 23C32.6569 23 34 21.2091 34 19C34 16.7909 32.6569 15 31 15C29.3431 15 28 16.7909 28 19C28 21.2091 29.3431 23 31 23Z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M16 28.3431C16 31.4673 19.5817 36 24 36C28.4183 36 32 31.4673 32 28.3431C32 25.219 16 25.219 16 28.3431Z"></path>
                        </svg>
                    </div>
                </button>
                <div x-show="emojiOpen" x-ref="pickerContainer" class="absolute bottom-12 right-0 z-50"></div>
            </div>
            <button type="submit" class="bg-[#366BF5] hover:bg-[#5037F8] text-white rounded-md px-7 py-2">
                Envoyer
            </button>
        </form>
    </div>
</div>

<title hx-swap-oob="true">Massages - Projet Dev</title>

<div hx-swap-oob="innerHTML" id="navigation">
    {% include "includes/navigation.html" %}
</div>

<span id="unread-badge-{{ chat.id }}" hx-swap-oob="true"></span>


<script>
function emojiPicker() {
  return {
    emojiOpen: false,
    picker: null,
    emojiToggle() {
      this.emojiOpen = !this.emojiOpen
      if (this.emojiOpen && !this.picker) {
        this.picker = new EmojiMart.Picker({
          onEmojiSelect: emoji => {
            this.$refs.messageInput.value += emoji.native;
          }
        })
        this.$refs.pickerContainer.appendChild(this.picker)
      }
    }
  }
}

function scrollMessagesToBottom() {
  const el = document.getElementById("messages-list");
    if (!el) return;

  const images = el.querySelectorAll("img");
  const scroll = () => el.scrollTop = el.scrollHeight;

  if (!images.length) return scroll();

  let loaded = 0;
  images.forEach(img => {
    if (img.complete) {
      loaded++;
    } else {
      img.addEventListener("load", () => {
        loaded++;
        if (loaded === images.length) scroll();
      }, { once: true });
    }
  });

  if (loaded === images.length) scroll();
}
</script>