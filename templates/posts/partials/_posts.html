{% load static %}
{% load django_vite %}

{% if posts %}
{% for post in posts %}
    <article data-index="{{ forloop.counter0|add:page_start_index }}" class="h-full snap-start mx-auto py-2 px-4 flex justify-center items-center">
        <div class="relative bg-black max-h-full max-w-full lg:h-full rounded-2xl aspect-[9/16] flex justify-center items-center">

            <button @click="modalPage = true; returnUrl = window.location.pathname;"
                    hx-get="{% url 'posts:post_page' post.uuid %}"
                    hx-target="#modalpage-content"
                    hx-swap="innerHTML"
                    hx-push-url="true"
                    class="absolute inset-0 z-10">
            </button>

            <img src="{{ post.image.url }}" alt="" class="aspect-[9/16] rounded-2xl object-cover">

            <article-info class="absolute bottom-0 left-0 right-0 z-20 pointer-events-none">
                <div class="absolute bottom-0 p-5 text-white z-10">

                    {% if post.author %}
                        <a href="{% url 'users:profile' post.author.username %}" class="hover:underline pointer-events-auto">{{ post.author }}</a>
                    {% endif %}

                    {% if post.tags.exists %}
                        <div class="mt-1">
                            {% for tag in post.tags.all %}
                                <a href="{% url 'search:search' %}?q={{ tag.name }}" class="hover:underline pointer-events-auto mr-2">{{ tag }}</a>
                            {% endfor %}
                        </div>
                    {% endif %}

                </div>
                <div class="h-64 w-full bg-gradient-to-t from-black to-transparent opacity-30 rounded-b-2xl"></div>
            </article-info>

            <article-buttons class="absolute -right-17 bottom-0 flex flex-col gap-2">

                <div id="author_home_{{ post.uuid }}">
                {% include "./_author_home.html" %}
                </div>

                <div id="like_home_{{ post.uuid }}">
                    {% include "./_like_home.html" %}
                </div>

                <button id="comment" 
                        @click="modalPage = true; returnUrl = window.location.pathname;"
                        hx-get="{% url 'posts:post_page' post.uuid %}"
                        hx-target="#modalpage-content"
                        hx-swap="innerHTML"
                        hx-push-url="true" class="cursor-pointer">
                    <div class="button-article dark:!bg-neutral-800 hover:dark:!bg-neutral-900">
                        <div class="size-6">
                            <svg viewBox="0 0 48 48">
                                <path fill-rule="evenodd" d="M2 21.5c0-10.22 9.88-18 22-18s22 7.78 22 18c0 5.63-3.19 10.74-7.32 14.8a43.6 43.6 0 0 1-14.14 9.1A1.5 1.5 0 0 1 22.5 44v-5.04C11.13 38.4 2 31.34 2 21.5M14 25a3 3 0 1 0 0-6 3 3 0 0 0 0 6m10 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6m13-3a3 3 0 1 1-6 0 3 3 0 0 1 6 0" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                    <p class="font-bold text-xs text-neutral-600 dark:text-neutral-400 pt-1">
                        {{ post.comments.count }}
                    </p>
                </button>

                <div id="bookmark_home_{{ post.uuid }}">
                    {% include "./_bookmark_home.html" %}
                </div>

                <button id="share" class="cursor-pointer"
                        @click="modalBox = true";
                        hx-get="{% url "posts:share_post" post.uuid %}"
                        hx-target="#modalbox-content"
                        hx-swap="innerHTML">
                    <div class="button-article dark:!bg-neutral-800 hover:dark:!bg-neutral-900">
                        <div class="size-6">
                            <svg viewBox="0 0 20 20">
                                <path d="M10.938 3.175a.674.674 0 0 1 1.138-.488l6.526 6.215c.574.547.554 1.47-.043 1.991l-6.505 5.676a.674.674 0 0 1-1.116-.508V13.49s-6.985-1.258-9.225 2.854c-.209.384-1.023.518-.857-1.395.692-3.52 2.106-9.017 10.082-9.017z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                    <p class="font-bold text-xs text-neutral-600 dark:text-neutral-400 pt-1">
                        {{ post.reposts.count }}
                    </p>
                </button>

                {% if post.is_repost and post.author %}
                <button id="author" 
                        hx-get="{% url 'users:profile' post.author.username %}"
                        hx-target="#main-content"
                        hx-swap="innerHTML transition:true"
                        hx-push-url="true"
                        class="relative cursor-pointer flex justify-center mb-4">
                    <div class="rounded-full size-9 bg-neutral-100 overflow-hidden">
                        <img src="{{ post.author.avatar }}" alt="" class="w-full h-full object-center object-cover">
                    </div>
                </button>
                {% endif %}
            </article-buttons>
        </div>
    </article>
{% endfor %}
{% else %}
<div class="h-full mx-auto flex justify-center items-center lg:mr-60">
    <a href="{% url 'posts:explore' %}" class="hover:underline font-medium text-neutral-400 text-sm">
        Suivez vos premiers comptes et partagez vos photos pour démarrer votre expérience.
    </a>
</div>
{% endif %}

{% if next_page %}
    <div
        hx-get="{% url 'posts:home' %}?paginator=true&page_number={{ next_page }}"
        hx-trigger="intersect once"
        hx-swap="outerHTML"
        >
    </div>
{% endif %}
